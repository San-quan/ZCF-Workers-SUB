-- OpenWRT mwan3 多WAN配置脚本 (Starlink + 本地线路回国优化)
-- 作者: 艾米 (sanquan开发, 2025.09.25)
-- 使用: SSH进路由器, 保存为 /etc/mwan_setup.lua, 运行 lua /etc/mwan_setup.lua

#!/usr/bin/env lua

-- 导入UCI模块
local uci = require "luci.model.uci".cursor()

-- 步骤1: 配置wan2接口 (DHCP客户端, 接LAN2端口)
uci:section("network", "interface", "wan2", {
    proto = "dhcp",
    ifname = "eth1.2",  -- 假设LAN2端口, 根据你的网卡调整 (ip link show查)
    metric = 20,  -- 优先级低于wan (10)
    peerdns = "0"  -- 禁用DNS, 用自定义
})
uci:set("network", "wan2", "defaultroute", "1")

-- 步骤2: 配置mwan3接口
uci:section("mwan3", "interface", "wan_mwan", {
    enabled = "1",
    interface = "wan",
    track_ip = "8.8.8.8",  -- Starlink主线ping目标
    track_method = "ping",
    reliability = "2",
    count = "1",
    timeout = "2",
    interval = "5",
    down = "3",
    up = "8"
})
uci:section("mwan3", "interface", "wan2_mwan", {
    enabled = "1",
    interface = "wan2",
    track_ip = "114.114.114.114",  -- 辅线ping中国DNS (回国优化)
    track_method = "ping",
    reliability = "2",
    count = "1",
    timeout = "2",
    interval = "5",
    down = "3",
    up = "8"
})

-- 步骤3: 配置策略 (failover模式: Starlink主, 辅线备; 可改balance 50/50)
uci:section("mwan3", "policy", "failover_policy", {
    last_resort = "wan_mwan",
    use_policy_table = "1"
})
uci:config_set("mwan3", "policy", "failover_policy", "use_rule_table", "1")
uci:config_list("mwan3", "policy", "failover_policy", "use_member", "wan_mwan 1 1")
uci:config_list("mwan3", "policy", "failover_policy", "use_member", "wan2_mwan 2 2")

-- 步骤4: 配置规则 (所有流量用failover策略; 加国内直连wan2)
uci:section("mwan3", "rule", "default_rule", {
    dest_ip = "0.0.0.0/0",
    proto = "all",
    sticky = "0",
    use_policy = "failover_policy"
})
-- 国内规则: geosite:cn走wan2 (低延迟本地线)
uci:section("mwan3", "rule", "cn_direct_rule", {
    dest_ip = "0.0.0.0/0",
    src_ip = "192.168.1.0/24",  -- LAN网段
    proto = "tcp udp",
    use_policy = "wan2_only",  -- 自定义wan2策略
    family = "ipv4"
})

-- 步骤5: 自定义wan2_only策略 (国内直连)
uci:section("mwan3", "policy", "wan2_only", {
    last_resort = "unreachable",
    use_policy_table = "1"
})
uci:config_list("mwan3", "policy", "wan2_only", "use_member", "wan2_mwan 1 1")

-- 步骤6: 提交配置并重启服务
uci:commit("network")
uci:commit("mwan3")
os.execute("/etc/init.d/network restart")
os.execute("/etc/init.d/mwan3 restart")

-- 输出确认
print("配置完成! 检查 mwan3 status. 重启路由器生效。")p
