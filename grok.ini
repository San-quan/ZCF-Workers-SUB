; ChinaDomain-BackCN-Overseas.ini - 2025 缅甸 Starlink Meta内核优化版，回国+海外分组模板（规则优化增强）
; 作者: 艾米 (sanquan 开发者)
; 版本: 1.7 (2025/10/14)
; 用途: Subconverter 生成 Clash Meta YAML - 中国 app 走回国，非中国走香港/海外，兜底海外 + OpenWRT 接口分流 + 规则性能优化
; 来源: ACL4SSR BackCN + Loyalsoldier GeoSite + Subconverter v0.9.10 + Meta内核v1.18+
; 使用: Subconverter 输入此 INI + 订阅 URL 生成 YAML，规则模式，Fake-IP 防泄漏，TUN流量控制
; 更新: interval=43200 (12h)，订阅自动拉取 + url-test 延迟测试 <20ms (规则优化)
; 优化: IPv6 支持，Proxy Providers 订阅，nameserver-policy DNS 分流 (MosDNS兼容) + TUN模式 + 规则顺序/合并/扩展 (Apple/Netflix)

[general]
loglevel = info
append = false
skip-missed = true
tproxy = true  # OpenWRT TProxy/TUN 兼容 (Meta优先TUN)
error-report = true  # 错误日志
log-file = /tmp/subconverter.log  # 调试用

[rule_provider]
; 中国 IP/域名规则源 (回国组代理逻辑，优化：合并baidu/tencent)
geoip-cn = type: http, behavior: classical, url: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/CN.txt", path: ./ruleset/geoip-cn.yaml, interval: 43200
geoip-cn-v6 = type: http, behavior: classical, url: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/CN_v6.txt", path: ./ruleset/geoip-cn-v6.yaml, interval: 43200  # IPv6
geosite-cn = type: http, behavior: classical, url: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geosite-cn.dat", path: ./ruleset/geosite-cn.yaml, interval: 43200

; 电商/支付/社交/短视频/搜索引擎 (淘宝、支付宝、微信、抖音、快手、百度等，走回国组；优化：新增apple-cn)
alibaba = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Alibaba.list", path: ./ruleset/alibaba.yaml, interval: 43200
jd = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/JD.list", path: ./ruleset/jd.yaml, interval: 43200
alipay = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Alipay.list", path: ./ruleset/alipay.yaml, interval: 43200
tencent-baidu = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Tencent.list", path: ./ruleset/tencent-baidu.yaml, interval: 43200  # 合并微信/QQ/百度
bilibili = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Bilibili.list", path: ./ruleset/bilibili.yaml, interval: 43200
douyin = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Douyin.list", path: ./ruleset/douyin.yaml, interval: 43200  # 抖音
kuaishou = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Kuaishou.list", path: ./ruleset/kuaishou.yaml, interval: 43200  # 快手
meituan = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Meituan.list", path: ./ruleset/meituan.yaml, interval: 43200
didi = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/DiDi.list", path: ./ruleset/didi.yaml, interval: 43200
apple-cn = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Apple.list", path: ./ruleset/apple-cn.yaml, interval: 43200  # 新增：Apple CN

; 广告/墙外 (REJECT / 海外组；优化：gfw扩展Netflix)
banad = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list", path: ./ruleset/banad.yaml, interval: 43200
gfw-netflix = type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/GreatFire.list", path: ./ruleset/gfw-netflix.yaml, interval: 43200  # 合并GFW+Netflix

[template]
; YAML 头部 + 通用设置 (mixed-port 等，Meta TUN优化)
clash-config = |
  mixed-port: 7890
  allow-lan: true
  mode: rule
  log-level: info  # Meta优化：info减日志负载
  external-controller: 0.0.0.0:9090
  secret: ""
  ipv6: true
  tun:
    enable: true  # Meta TUN模式：全局流量控制，提升兼容
    stack: system  # system栈优化UDP
    dns-hijack:
      - any:53
    auto-route: true
    auto-detect-interface: true

; Proxy Providers (订阅自动更新 + health-check 延迟测试<20ms，Meta加密升级)
proxy-providers = |
  china_subscription:
    type: http
    url: "${china_sub_url}"  # 替换: 您的中国订阅 URL
    interval: 1800  # Meta优化：30min更新，减负载
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204"
      interval: 180  # 3min检查
      lazy: true  # Meta懒加载
  hongkong_subscription:
    type: http
    url: "${hk_sub_url}"  # 替换: 香港订阅 URL
    interval: 1800
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204"
      interval: 180
      lazy: true
  overseas_subscription:
    type: http
    url: "${overseas_sub_url}"  # 替换: 海外订阅 URL
    interval: 1800
    health-check:
      enable: true
      url: "http://www.gstatic.com/generate_204"
      interval: 180
      lazy: true

; 示例 Proxies (订阅覆盖；Meta支持trojan-gsi等新协议)
proxies = |
  - name: 🇨🇳回国节点
    type: ss
    server: ${CN_SERVER}
    port: ${CN_PORT}
    cipher: ${CN_ENCRYPTION}  # Meta优化：支持2022-blake3
    password: ${CN_PASSWORD}
    udp: true
    ipv6: true
  - name: 🇭🇰香港节点
    type: vmess
    server: ${HK_SERVER}
    port: ${HK_PORT}
    uuid: ${HK_UUID}
    alterId: 0
    cipher: auto
    tls: true
    network: ws
    ws-path: /ws
    ws-headers:
      Host: ${HK_HOST}
    udp: true
    ipv6: true
  - name: 🇺🇸海外最优
    type: trojan
    server: ${US_SERVER}
    port: ${US_PORT}
    password: ${US_PASSWORD}
    sni: ${US_SNI}
    udp: true
    ipv6: true

; Proxy Groups (url-test 延迟测试，确保可用，Meta tolerance减至15ms)
proxy-groups = |
  - name: 🇨🇳回国组
    type: url-test
    proxies:
      - china_subscription
      - 🇭🇰香港节点
      - 🇺🇸海外最优
    url: "http://www.gstatic.com/generate_204"
    interval: 180  # Meta优化：3min
    tolerance: 15  # <20ms阈值
  - name: 🇭🇰香港组
    type: url-test
    proxies:
      - hongkong_subscription
      - 🇺🇸海外最优
      - 🇨🇳回国组
    url: "http://www.gstatic.com/generate_204"
    interval: 180
    tolerance: 15
  - name: 🇺🇸海外组
    type: url-test
    proxies:
      - overseas_subscription
      - 🇭🇰香港节点
      - 🇨🇳回国组
    url: "http://www.gstatic.com/generate_204"
    interval: 180
    tolerance: 15

; DNS 配置 (Meta重构：分流+DoH fallback+nameserver-policy扩展，MosDNS兼容，减少重复查询)
dns = |
  enable: true
  ipv6: true
  enhanced-mode: fake-ip  # Meta Fake-IP防泄漏
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter:
    - "+.lan"  # Meta优化：LAN直连
    - "*.msftncsi.com"
    - "localhost.ptlogin2.qq.com"
  default-nameserver:
    - 114.114.114.114
    - 8.8.8.8
  nameserver:
    - 114.114.114.114
    - 223.5.5.5
    - tls://dns.rubyfish.cn:853  # Meta DoT支持
  fallback:
    - https://dns.cloudflare.com/dns-query
    - https://doh.360.cn/dns-query
    - https://dns.google/dns-query
    - tls://1.1.1.1:853  # Meta增强fallback
  fallback-filter:
    geoip: false
    ipcidr:
      - 240.0.0.0/4
      - geoip:cn  # Meta：CN fallback过滤
    geoip-code: CN
  nameserver-policy:
    "geosite:cn": 114.114.114.114  # CN直连DNS
    "+.google.com,+.*.goog": https://dns.cloudflare.com/dns-query
    "geosite:apple-cn": 114.114.114.114  # Apple CN分流
    "geosite:msft": 223.5.5.5  # Microsoft优化
    "netflix.com,*.netflix.com": https://dns.cloudflare.com/dns-query  # 新增：Netflix DNS

; Rule Providers (动态拉取，优化：合并tencent-baidu/gfw-netflix)
rule-providers = |
  geoip-cn: type: http, behavior: classical, url: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/CN.txt", path: ./ruleset/geoip-cn.yaml, interval: 43200
  geoip-cn-v6: type: http, behavior: classical, url: "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/CN_v6.txt", path: ./ruleset/geoip-cn-v6.yaml, interval: 43200
  geosite-cn: type: http, behavior: classical, url: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/geosite-cn.dat", path: ./ruleset/geosite-cn.yaml, interval: 43200
  alibaba: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Alibaba.list", path: ./ruleset/alibaba.yaml, interval: 43200
  jd: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/JD.list", path: ./ruleset/jd.yaml, interval: 43200
  alipay: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Alipay.list", path: ./ruleset/alipay.yaml, interval: 43200
  tencent-baidu: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Tencent.list", path: ./ruleset/tencent-baidu.yaml, interval: 43200  # 合并
  bilibili: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Bilibili.list", path: ./ruleset/bilibili.yaml, interval: 43200
  douyin: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Douyin.list", path: ./ruleset/douyin.yaml, interval: 43200
  kuaishou: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Kuaishou.list", path: ./ruleset/kuaishou.yaml, interval: 43200
  meituan: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Meituan.list", path: ./ruleset/meituan.yaml, interval: 43200
  didi: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/DiDi.list", path: ./ruleset/didi.yaml, interval: 43200
  apple-cn: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Apple.list", path: ./ruleset/apple-cn.yaml, interval: 43200
  banad: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list", path: ./ruleset/banad.yaml, interval: 43200
  gfw-netflix: type: http, behavior: classical, url: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/GreatFire.list", path: ./ruleset/gfw-netflix.yaml, interval: 43200  # 合并

; 路由规则 (ACL4SSR 优化 + 接口分流: 顺序重排 - 先源IP/私有 > CN规则 > GFW/海外 > 广告 > MATCH；新增Apple/Netflix)
backcn-rules = |
  ; 接口分流 (基于源IP，优先级最高，Meta TUN支持)
  - IP-CIDR6,fc00::/7,DIRECT,no-resolve  # 本地IPv6直连
  - IP-CIDR,192.168.1.0/24,🇨🇳回国组,no-resolve  # lan1/lan2
  - IP-CIDR,192.168.3.0/24,🇺🇸海外组,no-resolve  # lan3 (香港+海外)
  - IP-CIDR,192.168.4.0/24,DIRECT,no-resolve  # lan4 直连
  - IP-CIDR,192.168.2.0/24,🇭🇰香港组,no-resolve  # WiFi 5G
  ; 私有网直连兜底 (优化：移到源IP后)
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,100.64.0.0/10,DIRECT,no-resolve
  ; 中国规则 (走回国组，优化：合并tencent-baidu)
  - RULE-SET,geoip-cn,🇨🇳回国组
  - RULE-SET,geoip-cn-v6,🇨🇳回国组
  - RULE-SET,geosite-cn,🇨🇳回国组
  - RULE-SET,alibaba,🇨🇳回国组
  - RULE-SET,jd,🇨🇳回国组
  - RULE-SET,alipay,🇨🇳回国组
  - RULE-SET,tencent-baidu,🇨🇳回国组  # 合并微信/QQ/百度
  - RULE-SET,bilibili,🇨🇳回国组
  - RULE-SET,douyin,🇨🇳回国组
  - RULE-SET,kuaishou,🇨🇳回国组
  - RULE-SET,meituan,🇨🇳回国组
  - RULE-SET,didi,🇨🇳回国组
  - RULE-SET,apple-cn,🇨🇳回国组  # 新增Apple CN
  ; 墙外/海外 (走香港/海外组，优化：gfw-netflix全香港，Netflix兜底海外)
  - RULE-SET,gfw-netflix,🇭🇰香港组  # 合并GFW+Netflix
  - DOMAIN-SUFFIX,google.com,🇭🇰香港组
  - DOMAIN-SUFFIX,youtube.com,🇭🇰香港组
  - DOMAIN-SUFFIX,facebook.com,🇺🇸海外组
  - DOMAIN-SUFFIX,netflix.com,🇺🇸海外组  # Netflix海外优化
  ; 广告阻挡 (末尾，避免冲突)
  - RULE-SET,banad,REJECT
  ; 兜底 (Meta MATCH优化)
  - MATCH,🇺🇸海外组
